module Mesh_smoothing
    implicit NONE
    contains



    function Tri_energy_3D(xs) result(E)
        implicit NONE
        real,intent(in) :: xs(3,3)
        real :: x1,x2,x3,y1,y2,y3,z1,z2,z3,E

        x1=xs(1,1)
        x2=xs(2,1)
        x3=xs(3,1)
        y1=xs(1,2)
        y2=xs(2,2)
        y3=xs(3,2)
        z1=xs(1,3)
        z2=xs(2,3)
        z3=xs(3,3)

        E = sqrt(x1*x2*(-2.0D0)-x1*x3*2.0D0-y1*y2*2.0D0-y1*y3*2.0D0-z1*z2&
        *2.0D0-z1*z3*2.0D0+x1**2*2.0D0+x2**2+x3**2+y1**2*2.0D0+y2**2+y3**2&
        +z1**2*2.0D0+z2**2+z3**2)
    end function Tri_energy_3D

    function Tri_energy_3D_grad(xs) result(Grad)
        implicit NONE
        real,intent(in) :: xs(3,3)
        real :: x1,x2,x3,y1,y2,y3,z1,z2,z3,Grad(3,3)

        x1=xs(1,1)
        x2=xs(2,1)
        x3=xs(3,1)
        y1=xs(1,2)
        y2=xs(2,2)
        y3=xs(3,2)
        z1=xs(1,3)
        z2=xs(2,3)
        z3=xs(3,3)

        Grad(1,1) = (x1*(-4.0D0)+x2*2.0D0+x3*2.0D0)*1.0D0/sqrt(x1*x2*(-2.0D0)&
        -x1*x3*2.0D0-y1*y2*2.0D0-y1*y3*2.0D0-z1*z2*2.0D0-z1*z3*2.0D0+x1&
        **2*2.0D0+x2**2+x3**2+y1**2*2.0D0+y2**2+y3**2+z1**2*2.0D0+z2**2+z3&
        **2)*(-1.0D0/2.0D0)

        Grad(1,2) = (y1*(-4.0D0)+y2*2.0D0+y3*2.0D0)*1.0D0/sqrt(x1*x2*(-2.0D0)&
        -x1*x3*2.0D0-y1*y2*2.0D0-y1*y3*2.0D0-z1*z2*2.0D0-z1*z3*2.0D0+x1&
        **2*2.0D0+x2**2+x3**2+y1**2*2.0D0+y2**2+y3**2+z1**2*2.0D0+z2**2+z3&
        **2)*(-1.0D0/2.0D0)

        Grad(1,3) = (z1*(-4.0D0)+z2*2.0D0+z3*2.0D0)*1.0D0/sqrt(x1*x2*(-2.0D0)&
        -x1*x3*2.0D0-y1*y2*2.0D0-y1*y3*2.0D0-z1*z2*2.0D0-z1*z3*2.0D0+x1&
        **2*2.0D0+x2**2+x3**2+y1**2*2.0D0+y2**2+y3**2+z1**2*2.0D0+z2**2+z3&
        **2)*(-1.0D0/2.0D0)

        Grad(2,1) = (x1*2.0D0-x2*2.0D0)*1.0D0/sqrt(x1*x2*(-2.0D0)-x1*x3*2.0D0&
        -y1*y2*2.0D0-y1*y3*2.0D0-z1*z2*2.0D0-z1*z3*2.0D0+x1**2*2.0D0+x2&
        **2+x3**2+y1**2*2.0D0+y2**2+y3**2+z1**2*2.0D0+z2**2+z3**2)*(-1.0D0&
        /2.0D0)
         
        Grad(2,2) = (y1*2.0D0-y2*2.0D0)*1.0D0/sqrt(x1*x2*(-2.0D0)-x1*x3*2.0D0&
        -y1*y2*2.0D0-y1*y3*2.0D0-z1*z2*2.0D0-z1*z3*2.0D0+x1**2*2.0D0+x2&
        **2+x3**2+y1**2*2.0D0+y2**2+y3**2+z1**2*2.0D0+z2**2+z3**2)*(-1.0D0&
        /2.0D0)
        
        Grad(2,3) = (z1*2.0D0-z2*2.0D0)*1.0D0/sqrt(x1*x2*(-2.0D0)-x1*x3*2.0D0&
        -y1*y2*2.0D0-y1*y3*2.0D0-z1*z2*2.0D0-z1*z3*2.0D0+x1**2*2.0D0+x2&
        **2+x3**2+y1**2*2.0D0+y2**2+y3**2+z1**2*2.0D0+z2**2+z3**2)*(-1.0D0&
        /2.0D0)
        
        Grad(3,1) = (x1*2.0D0-x3*2.0D0)*1.0D0/sqrt(x1*x2*(-2.0D0)-x1*x3*2.0D0&
        -y1*y2*2.0D0-y1*y3*2.0D0-z1*z2*2.0D0-z1*z3*2.0D0+x1**2*2.0D0+x2&
        **2+x3**2+y1**2*2.0D0+y2**2+y3**2+z1**2*2.0D0+z2**2+z3**2)*(-1.0D0&
        /2.0D0)
        
        Grad(3,2) = (y1*2.0D0-y3*2.0D0)*1.0D0/sqrt(x1*x2*(-2.0D0)-x1*x3*2.0D0&
        -y1*y2*2.0D0-y1*y3*2.0D0-z1*z2*2.0D0-z1*z3*2.0D0+x1**2*2.0D0+x2&
        **2+x3**2+y1**2*2.0D0+y2**2+y3**2+z1**2*2.0D0+z2**2+z3**2)*(-1.0D0&
        /2.0D0)
        
        Grad(3,3) = (z1*2.0D0-z3*2.0D0)*1.0D0/sqrt(x1*x2*(-2.0D0)-x1*x3*2.0D0&
        -y1*y2*2.0D0-y1*y3*2.0D0-z1*z2*2.0D0-z1*z3*2.0D0+x1**2*2.0D0+x2&
        **2+x3**2+y1**2*2.0D0+y2**2+y3**2+z1**2*2.0D0+z2**2+z3**2)*(-1.0D0&
        /2.0D0)
    end function Tri_energy_3D_grad

    function Area(xs) result(A)
        implicit NONE
        real,intent(in) :: xs(3,3)
        real :: x1,x2,x3,y1,y2,y3,z1,z2,z3,A

        x1=xs(1,1)
        x2=xs(2,1)
        x3=xs(3,1)
        y1=xs(1,2)
        y2=xs(2,2)
        y3=xs(3,2)
        z1=xs(1,3)
        z2=xs(2,3)
        z3=xs(3,3)

        A = sqrt(x1*x2*(-2.0D0)-x1*x3*2.0D0-y1*y2*2.0D0-y1*y3*2.0D0-z1*z2&
        *2.0D0-z1*z3*2.0D0+x1**2*2.0D0+x2**2+x3**2+y1**2*2.0D0+y2**2+y3**2&
        +z1**2*2.0D0+z2**2+z3**2)
    end function Area

    function Tri_energy_3d_hess(xs) result(Hess)
        implicit NONE
        real,intent(in) :: xs(3,3)
        real :: x1,x2,x3,y1,y2,y3,z1,z2,z3,Hess(3,3,3)

        x1=xs(1,1)
        x2=xs(2,1)
        x3=xs(3,1)
        y1=xs(1,2)
        y2=xs(2,2)
        y3=xs(3,2)
        z1=xs(1,3)
        z2=xs(2,3)
        z3=xs(3,3)

        Hess(1,1,1) = (x1*(-4.0D0)+x2*2.0D0+x3*2.0D0)**2*1.0D0/(x1*x2*(-2.0D0)-x1*x3*2.0D0-y1*y2&
        *2.0D0-y1*y3*2.0D0-z1*z2*2.0D0-z1*z3*2.0D0+x1**2*2.0D0+x2**2+x3**2+y1**2*2.0D0+y2**2+y3&
        **2+z1**2*2.0D0+z2**2+z3**2)**(3.0D0/2.0D0)*(-1.0D0/4.0D0)+1.0D0/sqrt(x1*x2*(-2.0D0)-x1*x3&
        *2.0D0-y1*y2*2.0D0-y1*y3*2.0D0-z1*z2*2.0D0-z1*z3*2.0D0+x1**2*2.0D0+x2**2+x3**2+y1**2*2.0D0+y2&
        **2+y3**2+z1**2*2.0D0+z2**2+z3**2)*2.0D0      
        
        Hess(1,1,2) = (x1*(-4.0D0)+x2*2.0D0+x3*2.0D0)*(y1*(-4.0D0)+y2*2.0D0+y3*2.0D0)*1.0D0/(x1*x2&
        *(-2.0D0)-x1*x3*2.0D0-y1*y2*2.0D0-y1*y3*2.0D0-z1*z2*2.0D0-z1*z3*2.0D0+x1**2*2.0D0+x2**2+x3**2+y1**2&
        *2.0D0+y2**2+y3**2+z1**2*2.0D0+z2**2+z3**2)**(3.0D0/2.0D0)*(-1.0D0/4.0D0)
        
        Hess(1,1,3) = (x1*(-4.0D0)+x2*2.0D0+x3*2.0D0)*(z1*(-4.0D0)+z2*2.0D0+z3*2.0D0)*1.0D0/(x1*x2*&
        (-2.0D0)-x1*x3*2.0D0-y1*y2*2.0D0-y1*y3*2.0D0-z1*z2*2.0D0-z1*z3*2.0D0+x1**2*2.0D0+x2**2+x3&
        **2+y1**2*2.0D0+y2**2+y3**2+z1**2*2.0D0+z2**2+z3**2)**(3.0D0/2.0D0)*(-1.0D0/4.0D0) 
        
        Hess(1,2,1) = (x1*(-4.0D0)+x2*2.0D0+x3*2.0D0)*(y1*(-4.0D0)+y2*2.0D0+y3*2.0D0)*1.0D0/(x1*x2*(-2.0D0)&
        -x1*x3*2.0D0-y1*y2*2.0D0-y1*y3*2.0D0-z1*z2*2.0D0-z1*z3*2.0D0+x1**2*2.0D0+x2**2+x3**2+y1**2*2.0D0+y2**2&
        +y3**2+z1**2*2.0D0+z2**2+z3**2)**(3.0D0/2.0D0)*(-1.0D0/4.0D0)
        
        Hess(1,2,2) = (y1*(-4.0D0)+y2*2.0D0+y3*2.0D0)**2*1.0D0/(x1*x2*(-2.0D0)-x1*x3*2.0D0-y1*y2*2.0D0-y1*y3*2.0D0-z1&
        *z2*2.0D0-z1*z3*2.0D0+x1**2*2.0D0+x2**2+x3**2+y1**2*2.0D0+y2**2+y3**2+z1**2*2.0D0+z2**2+z3**2)**(3.0D0/2.0D0)&
        *(-1.0D0/4.0D0)+1.0D0/sqrt(x1*x2*(-2.0D0)-x1*x3*2.0D0-y1*y2*2.0D0-y1*y3*2.0D0-z1*z2*2.0D0-z1*z3*2.0D0+x1**2*2.0D0&
        +x2**2+x3**2+y1**2*2.0D0+y2**2+y3**2+z1**2*2.0D0+z2**2+z3**2)*2.0D0 
        
        Hess(1,2,3) = (y1*(-4.0D0)+y2*2.0D0+y3*2.0D0)*(z1*(-4.0D0)+z2*2.0D0+z3*2.0D0)*1.0D0/(x1*x2*(-2.0D0)-x1*x3*2.0D0&
        -y1*y2*2.0D0-y1*y3*2.0D0-z1*z2*2.0D0-z1*z3*2.0D0+x1**2*2.0D0+x2**2+x3**2+y1**2*2.0D0+y2**2+y3**2+z1**2&
        *2.0D0+z2**2+z3**2)**(3.0D0/2.0D0)*(-1.0D0/4.0D0)
        
        Hess(1,3,1) = (x1*(-4.0D0)+x2*2.0D0+x3*2.0D0)*(z1*(-4.0D0)+z2*2.0D0+z3*2.0D0)*1.0D0/(x1*x2*(-2.0D0)&
        -x1*x3*2.0D0-y1*y2*2.0D0-y1*y3*2.0D0-z1*z2*2.0D0-z1*z3*2.0D0+x1**2*2.0D0+x2**2+x3**2+y1**2*2.0D0+y2**2+y3**2&
        +z1**2*2.0D0+z2**2+z3**2)**(3.0D0/2.0D0)*(-1.0D0/4.0D0)
        
        Hess(1,3,2) = (y1*(-4.0D0)+y2*2.0D0+y3*2.0D0)*(z1*(-4.0D0)+z2*2.0D0+z3*2.0D0)*1.0D0/(x1*x2*(-2.0D0)-x1*x3*2.0D0-y1*y2&
        *2.0D0-y1*y3*2.0D0-z1*z2*2.0D0-z1*z3*2.0D0+x1**2*2.0D0+x2**2+x3**2+y1**2*2.0D0+y2**2+y3**2+z1**2*2.0D0&
        +z2**2+z3**2)**(3.0D0/2.0D0)*(-1.0D0/4.0D0)
        
        Hess(1,3,3) = (z1*(-4.0D0)+z2*2.0D0+z3*2.0D0)**2*1.0D0/(x1*x2*(-2.0D0)-x1*x3*2.0D0-y1*y2*2.0D0-y1*y3*2.0D0-z1*z2*2.0D0&
        -z1*z3*2.0D0+x1**2*2.0D0+x2**2+x3**2+y1**2*2.0D0+y2**2+y3**2+z1**2*2.0D0+z2**2+z3**2)**(3.0D0/2.0D0)&
        *(-1.0D0/4.0D0)+1.0D0/sqrt(x1*x2*(-2.0D0)-x1*x3*2.0D0-y1*y2*2.0D0-y1*y3*2.0D0-z1*z2*2.0D0-z1*z3*2.0D0+x1**2*2.0D0+x2**2&
        +x3**2+y1**2*2.0D0+y2**2+y3**2+z1**2*2.0D0+z2**2+z3**2)*2.0D0    
        
        Hess(2,1,1) = (x1*2.0D0-x2*2.0D0)**2*1.0D0/(x1*x2*(-2.0D0)-x1*x3*2.0D0-y1*y2*2.0D0-y1*y3*2.0D0-z1*z2*2.0D0-z1*z3*2.0D0&
        +x1**2*2.0D0+x2**2+x3**2+y1**2*2.0D0+y2**2+y3**2+z1**2*2.0D0+z2**2+z3**2)**(3.0D0/2.0D0)*(-1.0D0/4.0D0)+1.0D0/sqrt(x1*x2&
        *(-2.0D0)-x1*x3*2.0D0-y1*y2*2.0D0-y1*y3*2.0D0-z1*z2*2.0D0-z1*z3*2.0D0+x1**2*2.0D0+x2**2+x3**2+y1**2*2.0D0+y2**2+y3**2+z1&
        **2*2.0D0+z2**2+z3**2)
        
        Hess(2,1,2) = (x1*2.0D0-x2*2.0D0)*(y1*2.0D0-y2*2.0D0)*1.0D0/(x1*x2*(-2.0D0)-x1*x3*2.0D0-y1*y2*2.0D0-y1*y3*2.0D0&
        -z1*z2*2.0D0-z1*z3*2.0D0+x1**2*2.0D0+x2**2+x3**2+y1**2*2.0D0+y2**2+y3**2+z1**2*2.0D0+z2**2+z3**2)**(3.0D0/2.0D0)&
        *(-1.0D0/4.0D0)      
        
        Hess(2,1,3) = (x1*2.0D0-x2*2.0D0)*(z1*2.0D0-z2*2.0D0)*1.0D0/(x1*x2*(-2.0D0)-x1*x3*2.0D0-y1*y2&
        *2.0D0-y1*y3*2.0D0-z1*z2*2.0D0-z1*z3*2.0D0+x1**2*2.0D0+x2**2+x3**2+y1**2*2.0D0+y2**2+y3**2+z1**2*2.0D0+z2**2+z3**2)&
        **(3.0D0/2.0D0)*(-1.0D0/4.0D0)  
        
        Hess(2,2,1) = (x1*2.0D0-x2*2.0D0)*(y1*2.0D0-y2*2.0D0)*1.0D0/(x1*x2*(-2.0D0)-x1*x3*2.0D0-y1*y2*2.0D0-y1*y3*2.0D0-z1*z2*2.0D0&
        -z1*z3*2.0D0+x1**2*2.0D0+x2**2+x3**2+y1**2*2.0D0+y2**2+y3**2+z1**2*2.0D0+z2**2+z3**2)**(3.0D0/2.0D0)*(-1.0D0/4.0D0)  
        
        Hess(2,2,2) = (y1*2.0D0-y2*2.0D0)**2*1.0D0/(x1*x2*(-2.0D0)-x1*x3*2.0D0-y1*y2*2.0D0-y1*y3*2.0D0-z1*z2*2.0D0-z1*z3*2.0D0&
        +x1**2*2.0D0+x2**2+x3**2+y1**2*2.0D0+y2**2+y3**2+z1**2*2.0D0+z2**2+z3**2)**(3.0D0/2.0D0)*(-1.0D0/4.0D0)+1.0D0/sqrt(x1&
        *x2*(-2.0D0)-x1*x3*2.0D0-y1*y2*2.0D0-y1*y3*2.0D0-z1*z2*2.0D0-z1*z3*2.0D0+x1**2*2.0D0+x2**2+x3**2+y1**2*2.0D0+y2**2&
        +y3**2+z1**2*2.0D0+z2**2+z3**2)
        
        Hess(2,2,3) = (y1*2.0D0-y2*2.0D0)*(z1*2.0D0-z2*2.0D0)*1.0D0/(x1*x2*(-2.0D0)-x1*x3*2.0D0-y1*y2*2.0D0-y1*y3*2.0D0&
        -z1*z2*2.0D0-z1*z3*2.0D0+x1**2*2.0D0+x2**2+x3**2+y1**2*2.0D0+y2**2+y3**2+z1**2*2.0D0+z2**2+z3**2)**(3.0D0&
        /2.0D0)*(-1.0D0/4.0D0)     
        
        Hess(2,3,1) = (x1*2.0D0-x2*2.0D0)*(z1*2.0D0-z2*2.0D0)*1.0D0/(x1*x2*(-2.0D0)-x1*x3*2.0D0-y1*y2*2.0D0-y1*y3*2.0D0&
        -z1*z2*2.0D0-z1*z3*2.0D0+x1**2*2.0D0+x2**2+x3**2+y1**2*2.0D0+y2**2+y3**2+z1**2*2.0D0+z2**2+z3**2)**(3.0D0/2.0D0)&
        *(-1.0D0/4.0D0)      
        
        Hess(2,3,2) = (y1*2.0D0-y2*2.0D0)*(z1*2.0D0-z2*2.0D0)*1.0D0/(x1*x2*(-2.0D0)-x1*x3*2.0D0-y1*y2*2.0D0-y1*y3*2.0D0&
        -z1*z2*2.0D0-z1*z3*2.0D0+x1**2*2.0D0+x2**2+x3**2+y1**2*2.0D0+y2**2+y3**2+z1**2*2.0D0+z2**2+z3**2)**(3.0D0/2.0D0)&
        *(-1.0D0/4.0D0) 
        
        Hess(2,3,3) = (z1*2.0D0-z2*2.0D0)**2*1.0D0/(x1*x2*(-2.0D0)-x1*x3*2.0D0-y1*y2*2.0D0-y1*y3*2.0D0-z1*z2*2.0D0-z1*z3&
        *2.0D0+x1**2*2.0D0+x2**2+x3**2+y1**2*2.0D0+y2**2+y3**2+z1**2*2.0D0+z2**2+z3**2)**(3.0D0/2.0D0)*(-1.0D0/4.0D0)&
        +1.0D0/sqrt(x1*x2*(-2.0D0)-x1*x3*2.0D0-y1*y2*2.0D0-y1*y3*2.0D0-z1*z2*2.0D0-z1*z3*2.0D0+x1**2*2.0D0+x2**2+x3**2&
        +y1**2*2.0D0+y2**2+y3**2+z1**2*2.0D0+z2**2+z3**2)
        
        !Hess(3,1,1) = (x1*2.0D0-x3*2.0D0)**2*1.0D0/(x1*x2*(-2.0D0)-x1*x3*2     &.0D0-y1*y2*2.0D0-y1*y3*2.0D0-z1*z2*2.0D0-z1*z3*2.0D0+x1**2*2.0D0+x     &2**2+x3**2+y1**2*2.0D0+y2**2+y3**2+z1**2*2.0D0+z2**2+z3**2)**(3.0D     &0/2.0D0)*(-1.0D0/4.0D0)+1.0D0/sqrt(x1*x2*(-2.0D0)-x1*x3*2.0D0-y1*y     &2*2.0D0-y1*y3*2.0D0-z1*z2*2.0D0-z1*z3*2.0D0+x1**2*2.0D0+x2**2+x3**     &2+y1**2*2.0D0+y2**2+y3**2+z1**2*2.0D0+z2**2+z3**2)      Hess(3,1,2) = (x1*2.0D0-x3*2.0D0)*(y1*2.0D0-y3*2.0D0)*1.0D0/(x1*x2     &*(-2.0D0)-x1*x3*2.0D0-y1*y2*2.0D0-y1*y3*2.0D0-z1*z2*2.0D0-z1*z3*2.     &0D0+x1**2*2.0D0+x2**2+x3**2+y1**2*2.0D0+y2**2+y3**2+z1**2*2.0D0+z2     &**2+z3**2)**(3.0D0/2.0D0)*(-1.0D0/4.0D0)      Hess(3,1,3) = (x1*2.0D0-x3*2.0D0)*(z1*2.0D0-z3*2.0D0)*1.0D0/(x1*x2     &*(-2.0D0)-x1*x3*2.0D0-y1*y2*2.0D0-y1*y3*2.0D0-z1*z2*2.0D0-z1*z3*2.     &0D0+x1**2*2.0D0+x2**2+x3**2+y1**2*2.0D0+y2**2+y3**2+z1**2*2.0D0+z2     &**2+z3**2)**(3.0D0/2.0D0)*(-1.0D0/4.0D0)      Hess(3,2,1) = (x1*2.0D0-x3*2.0D0)*(y1*2.0D0-y3*2.0D0)*1.0D0/(x1*x2     &*(-2.0D0)-x1*x3*2.0D0-y1*y2*2.0D0-y1*y3*2.0D0-z1*z2*2.0D0-z1*z3*2.     &0D0+x1**2*2.0D0+x2**2+x3**2+y1**2*2.0D0+y2**2+y3**2+z1**2*2.0D0+z2     &**2+z3**2)**(3.0D0/2.0D0)*(-1.0D0/4.0D0)      Hess(3,2,2) = (y1*2.0D0-y3*2.0D0)**2*1.0D0/(x1*x2*(-2.0D0)-x1*x3*2     &.0D0-y1*y2*2.0D0-y1*y3*2.0D0-z1*z2*2.0D0-z1*z3*2.0D0+x1**2*2.0D0+x     &2**2+x3**2+y1**2*2.0D0+y2**2+y3**2+z1**2*2.0D0+z2**2+z3**2)**(3.0D     &0/2.0D0)*(-1.0D0/4.0D0)+1.0D0/sqrt(x1*x2*(-2.0D0)-x1*x3*2.0D0-y1*y     &2*2.0D0-y1*y3*2.0D0-z1*z2*2.0D0-z1*z3*2.0D0+x1**2*2.0D0+x2**2+x3**     &2+y1**2*2.0D0+y2**2+y3**2+z1**2*2.0D0+z2**2+z3**2)      Hess(3,2,3) = (y1*2.0D0-y3*2.0D0)*(z1*2.0D0-z3*2.0D0)*1.0D0/(x1*x2     &*(-2.0D0)-x1*x3*2.0D0-y1*y2*2.0D0-y1*y3*2.0D0-z1*z2*2.0D0-z1*z3*2.     &0D0+x1**2*2.0D0+x2**2+x3**2+y1**2*2.0D0+y2**2+y3**2+z1**2*2.0D0+z2     &**2+z3**2)**(3.0D0/2.0D0)*(-1.0D0/4.0D0)      Hess(3,3,1) = (x1*2.0D0-x3*2.0D0)*(z1*2.0D0-z3*2.0D0)*1.0D0/(x1*x2     &*(-2.0D0)-x1*x3*2.0D0-y1*y2*2.0D0-y1*y3*2.0D0-z1*z2*2.0D0-z1*z3*2.     &0D0+x1**2*2.0D0+x2**2+x3**2+y1**2*2.0D0+y2**2+y3**2+z1**2*2.0D0+z2     &**2+z3**2)**(3.0D0/2.0D0)*(-1.0D0/4.0D0)      Hess(3,3,2) = (y1*2.0D0-y3*2.0D0)*(z1*2.0D0-z3*2.0D0)*1.0D0/(x1*x2     &*(-2.0D0)-x1*x3*2.0D0-y1*y2*2.0D0-y1*y3*2.0D0-z1*z2*2.0D0-z1*z3*2.     &0D0+x1**2*2.0D0+x2**2+x3**2+y1**2*2.0D0+y2**2+y3**2+z1**2*2.0D0+z2     &**2+z3**2)**(3.0D0/2.0D0)*(-1.0D0/4.0D0)      Hess(3,3,3) = (z1*2.0D0-z3*2.0D0)**2*1.0D0/(x1*x2*(-2.0D0)-x1*x3*2     &.0D0-y1*y2*2.0D0-y1*y3*2.0D0-z1*z2*2.0D0-z1*z3*2.0D0+x1**2*2.0D0+x     &2**2+x3**2+y1**2*2.0D0+y2**2+y3**2+z1**2*2.0D0+z2**2+z3**2)**(3.0D     &0/2.0D0)*(-1.0D0/4.0D0)+1.0D0/sqrt(x1*x2*(-2.0D0)-x1*x3*2.0D0-y1*y     &2*2.0D0-y1*y3*2.0D0-z1*z2*2.0D0-z1*z3*2.0D0+x1**2*2.0D0+x2**2+x3**     &2+y1**2*2.0D0+y2**2+y3**2+z1**2*2.0D0+z2**2+z3**2)
    end function Tri_energy_3d_hess


end module Mesh_smoothing